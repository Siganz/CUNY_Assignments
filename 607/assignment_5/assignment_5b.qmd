---
title: "assignment_5b"
format: html
toc: true
toc-depth: 5
toc-location: left
---

## Approach

```{r}
library(tidyverse)
df <- read_csv("chess_player.csv")
df
```
I kind of accidentally did the codebase prior to the approach. I was playing around with grabbing the code from Project 1 and then realized that if I wanted to calcualte ELO per game, I would need to alter the original code to extract the W/L/D from each of the games. So that meant modifying the str_replace formulas to place a | for every WLD. I have to check if people who skipped a game, would it matter or not (I don't think so?). 

Equation: 
`expected = 1 / (1 + 10 ^ ((opp - pre_rating) / 400))`
`diff = actual - expected`

```{r}
library(tidyverse)

#start
df_raw <- read_lines("tournamentinfo.txt")
df_raw_t <- tibble(df_raw)
var_1 <- c("pair", "name", "total_pts", as.vector(rbind(paste0("dec_", 1:7), paste0("opp_", 1:7))))
var_2 <- c("state", "match", "pre_rating", "post_rating")
var_3 <- c("pair", "name", "state", "pre_rating", "post_rating", "total_pts", as.vector(rbind(paste0("dec_", 1:7), paste0("opp_", 1:7))))
var_4 <- c("name", "state", "pre_rating", "post_rating", "total_pts")
var_5 <- c(paste0("d_", 1:7))

#Working
df <- tidyr::tibble(raw = df_raw) |>
  filter(
    !str_detect(raw, "^-"),
    !str_detect(raw, "\\s*Pair"),
    !str_detect(raw, "\\s*Num")
  ) |>
  mutate(index = row_number()) |>
  mutate(
    raw = str_trim(raw),
    raw = str_replace(raw, "\\|$", ""),
    raw = str_replace_all(raw, "\\|[BXN]\\s*", "|"),
    raw = str_replace_all(raw, "\\s*\\|\\s*", "|"),
    raw = str_replace_all(raw, "\\|:\\d\\s*", "|"),
    raw = str_replace_all(raw, "P\\d+", ""),
    raw = str_replace(raw, "->", "|"),
    raw = str_replace(raw, "R:", ""),
    raw = str_replace(raw, "/", "|"),
    raw = str_replace(raw, "\\|*\\|$", ""),
    raw = str_replace_all(raw, "\\|([WDL])\\s+(\\d+)", "|\\1|\\2"),
    raw = str_replace_all(raw, "\\|([HU])\\s*(?=\\|)", "|\\1|0"),
    raw = str_trim(raw)
    )

df1 <- df |> filter(index %% 2 != 0) |>
  separate(raw, sep = "\\|", into = var_1, extra = "drop", fill = "right") |>
  mutate(across(everything(), str_trim)) |>
  mutate(across(everything(), ~ na_if(.x, ""))) |>
  mutate(across(everything(), ~ na_if(.x, "0")))

df2 <- df |> filter(index %% 2 == 0) |>
  mutate(index = index - 1) |>
  separate(raw, sep = "\\|", into = var_2, extra = "drop", fill = "right") |>
  mutate(across(everything(), str_trim)) |>
  mutate(across(everything(), ~ na_if(.x, "")))

player_df <- df1 |> left_join(df2, by ='index')|> 
  select(all_of(var_3)) |>
  readr::type_convert()

rating_map <- setNames(player_df$pre_rating, player_df$pair)

player_df <- player_df |>
  mutate(across(starts_with("opp"), ~ unname(rating_map[.x])))

score_map <- c(W = 1, D = 0.5, L = 0, H = 0.5, U = 0)

df3 <- player_df |>
  pivot_longer(cols = matches("^(dec|opp)_"), names_to = c(".value", "round"), names_pattern = "(dec|opp)_(\\d+)") |>
  filter(!is.na(dec), !is.na(opp))

results <- df3 |>
  mutate(actual = score_map[dec], expected = 1 / (1 + 10 ^ ((opp - pre_rating) / 400))) |>
  group_by(name) |>
  summarise(actual_score = sum(actual), expected_score = sum(expected), diff = actual_score - expected_score, .groups = "drop")

top_overperformers <- results |> arrange(desc(diff)) |> slice_head(n = 5)
top_underperformers <- results |> arrange(diff) |> slice_head(n = 5)

top_overperformers
top_underperformers

```